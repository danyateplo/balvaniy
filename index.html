<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gemini Premium AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #000000;
      --card: #1c1c1e;
      --accent: #007aff;
      --text: #ffffff;
      --input: #2c2c2e;
    }

    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }

    .header {
      padding: 16px; background: rgba(28, 28, 30, 0.8);
      backdrop-filter: blur(20px); border-bottom: 0.5px solid #333;
      text-align: center; font-weight: 700;
    }

    .key-section {
      padding: 10px 15px; background: #161618; border-bottom: 1px solid #333;
    }
    .key-section input {
      width: 100%; background: var(--input); border: 1px solid #444;
      color: #fff; padding: 10px; border-radius: 12px; font-size: 13px; outline: none;
    }

    #chat {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 14px;
      scrollbar-width: thin; scrollbar-color: #444 transparent;
    }
    /* Стильный скроллбар для Chrome/Safari */
    #chat::-webkit-scrollbar { width: 4px; }
    #chat::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

    .bubble {
      max-width: 85%; padding: 12px 16px; border-radius: 20px;
      font-size: 16px; line-height: 1.4; animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } }

    .user { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; }
    .bot { align-self: flex-start; background: var(--card); border-bottom-left-radius: 4px; border: 1px solid #333; }

    .copy-btn { margin-top: 10px; font-size: 11px; color: #4da3ff; cursor: pointer; font-weight: bold; }

    .input-area {
      padding: 12px 12px 34px; background: rgba(28, 28, 30, 0.9);
      border-top: 1px solid #333;
    }
    .input-wrap {
      display: flex; background: var(--input); border-radius: 24px;
      padding: 5px 5px 5px 16px; align-items: center; border: 1px solid #444;
    }
    input#msg { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; padding: 10px 0; outline: none; }
    
    button#send-btn {
      background: #fff; border: none; width: 36px; height: 36px;
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    button#send-btn svg { fill: #000; width: 18px; height: 18px; }
    button:disabled { background: #555; opacity: 0.5; }
  </style>
</head>
<body>
  <div class="header">Gemini AI Premium</div>
  
  <div class="key-section">
    <input type="password" id="api-key" placeholder="Вставьте ваш Gemini API Key...">
  </div>

  <div id="chat">
    <div class="bubble bot">
      <b>Добро пожаловать!</b><br>
      Для начала работы вставьте свой API ключ сверху. Я его не храню, он сохраняется только в вашем браузере.<br><br>
      <small style="opacity: 0.6;">⚠️ История будет очищена после закрытия вкладки.</small>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <input id="msg" placeholder="Спросите о чем-нибудь..." autocomplete="off">
      <button id="send-btn" onclick="send()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msg');
  const keyInput = document.getElementById('api-key');
  const sendBtn = document.getElementById('send-btn');

  // Загружаем ключ из локального хранилища браузера
  keyInput.value = localStorage.getItem('user_gemini_key') || '';

  function addMessage(text, role) {
    const div = document.createElement('div');
    div.className = `bubble ${role}`;
    
    if (role === 'bot') {
      div.innerHTML = marked.parse(text);
      const copy = document.createElement('div');
      copy.className = 'copy-btn'; copy.innerText = 'КОПИРОВАТЬ';
      copy.onclick = () => {
        navigator.clipboard.writeText(text); copy.innerText = 'ГОТОВО!';
        setTimeout(() => copy.innerText = 'КОПИРОВАТЬ', 2000);
        tg.HapticFeedback.notificationOccurred('success');
      };
      div.appendChild(copy);
    } else {
      div.textContent = text;
    }

    chat.appendChild(div);
    chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
    return div;
  }

  async function send() {
    const text = msgInput.value.trim();
    const key = keyInput.value.trim();

    if (!text || sendBtn.disabled) return;
    if (!key) { alert('Введите API ключ в поле сверху!'); return; }

    localStorage.setItem('user_gemini_key', key); // Сохраняем ключ для удобства
    
    msgInput.value = '';
    tg.HapticFeedback.impactOccurred('light');
    addMessage(text, 'user');
    const load = addMessage('<i>Думаю...</i>', 'bot');

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, api_key: key })
      });
      const data = await res.json();
      load.remove();
      addMessage(data.answer, 'bot');

      if (data.is_limit) startTimer(20);
    } catch (e) {
      load.remove();
      addMessage('❌ Ошибка сети или сервера.', 'bot');
    }
  }

  function startTimer(sec) {
    let left = sec;
    msgInput.disabled = true; sendBtn.disabled = true;
    const itv = setInterval(() => {
      msgInput.placeholder = `Лимит! Ждем ${left}с...`;
      if (left-- <= 0) {
        clearInterval(itv); msgInput.disabled = false; sendBtn.disabled = false;
        msgInput.placeholder = "Спросите о чем-нибудь...";
      }
    }, 1000);
  }

  msgInput.addEventListener('keypress', (e) => { if(e.key==='Enter') send(); });
</script>
</body>
</html>
