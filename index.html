<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg: #000;
            --card: #1c1c1e;
            --accent: #007aff;
            --text: #fff;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* Тонкая статус-панель сверху */
        .status-bar {
            padding: 10px 15px; background: rgba(28,28,30,0.8);
            backdrop-filter: blur(20px); border-bottom: 1px solid #333;
            display: flex; gap: 10px; z-index: 10;
        }
        
        .status-bar input {
            flex: 1; background: #2c2c2e; border: 1px solid #444;
            color: #fff; padding: 8px 12px; border-radius: 10px; font-size: 12px; outline: none;
        }

        #chat {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth;
        }

        .bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: 16px; line-height: 1.4; animation: slideUp 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes slideUp { from { opacity:0; transform: translateY(10px); } }

        .user { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; }
        .bot { align-self: flex-start; background: var(--card); border-bottom-left-radius: 4px; border: 1px solid #333; }

        /* Стили для кода внутри Markdown */
        pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: auto; font-size: 13px; }
        code { font-family: monospace; color: #ff7b72; }

        .input-area {
            padding: 15px 15px 35px; background: rgba(28,28,30,0.9);
            backdrop-filter: blur(20px); border-top: 1px solid #333;
        }

        .input-wrap {
            display: flex; background: #2c2c2e; border-radius: 25px;
            padding: 5px 5px 5px 15px; align-items: center;
        }

        input#msg { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }

        .send-btn {
            background: #fff; border: none; width: 34px; height: 34px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }

        .send-btn:active { transform: scale(0.9); }
        .send-btn svg { fill: #000; width: 18px; height: 18px; }

        .loader { font-style: italic; opacity: 0.5; font-size: 14px; }
    </style>
</head>
<body>
    <div class="status-bar">
        <input type="password" id="api-key" placeholder="Вставь API Key (ai.google.dev)">
    </div>

    <div id="chat">
        <div class="bubble bot">
            Привет! Я обновлен. Вставь свой ключ в поле выше и мы можем начинать.
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrap">
            <input id="msg" placeholder="Сообщение..." autocomplete="off">
            <button class="send-btn" onclick="send()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.headerColor = "#1c1c1e";

        const chat = document.getElementById('chat');
        const msgInput = document.getElementById('msg');
        const keyInput = document.getElementById('api-key');

        // Авто-загрузка ключа
        keyInput.value = localStorage.getItem('my_ai_key') || '';

        function addMessage(text, role) {
            const div = document.createElement('div');
            div.className = `bubble ${role}`;
            div.innerHTML = role === 'bot' ? marked.parse(text) : text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }

        async function send() {
            const text = msgInput.value.trim();
            const key = keyInput.value.trim();

            if (!text || !key) {
                if(!key) alert('Вставь API ключ!');
                return;
            }

            localStorage.setItem('my_ai_key', key);
            msgInput.value = '';
            tg.HapticFeedback.impactOccurred('medium');

            addMessage(text, 'user');
            const load = addMessage('...', 'bot');
            load.classList.add('loader');

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, api_key: key })
                });
                const data = await res.json();
                load.remove();
                addMessage(data.answer, 'bot');
            } catch (e) {
                load.remove();
                addMessage('❌ Ошибка сети.', 'bot');
            }
        }

        msgInput.addEventListener('keypress', (e) => { if(e.key==='Enter') send(); });
    </script>
</body>
</html>
