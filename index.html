<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gemini Pro AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-color: #0a0a0c;
      --card-bg: #161618;
      --accent-color: #007aff;
      --accent-gradient: linear-gradient(135deg, #4da3ff, #b285ff);
      --text-main: #ffffff;
      --text-dim: #a1a1aa;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; background: var(--bg-color); color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* Шапка */
    .header {
      padding: 16px; background: rgba(22, 22, 24, 0.8);
      backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      text-align: center; z-index: 10;
    }
    .header-title {
      font-size: 18px; font-weight: 700; background: var(--accent-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    /* Чат */
    #chat {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
      scrollbar-width: none; /* Firefox */
    }
    #chat::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    .bubble {
      max-width: 85%; padding: 12px 16px; border-radius: 20px;
      font-size: 16px; line-height: 1.5; position: relative;
      animation: msgShow 0.3s ease;
    }
    @keyframes msgShow { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .user { align-self: flex-end; background: var(--accent-color); border-bottom-right-radius: 4px; }
    .bot { align-self: flex-start; background: var(--card-bg); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }

    .copy-btn {
      margin-top: 8px; font-size: 11px; color: var(--accent-color);
      cursor: pointer; text-transform: uppercase; font-weight: 700; opacity: 0.8;
    }

    /* Ввод */
    .input-box {
      padding: 12px 16px 34px; background: rgba(22, 22, 24, 0.9);
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .input-wrap {
      display: flex; align-items: center; background: #242426;
      border-radius: 24px; padding: 6px 6px 6px 16px;
      border: 1px solid rgba(255,255,255,0.1); transition: 0.3s;
    }
    .input-wrap:focus-within { border-color: var(--accent-color); background: #2a2a2c; }

    input {
      flex: 1; background: transparent; border: none; color: #fff;
      font-size: 16px; outline: none; padding: 8px 0;
    }
    button {
      background: #fff; border: none; width: 36px; height: 36px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s;
    }
    button:active { transform: scale(0.9); }
    button:disabled { background: #444; opacity: 0.5; }
    button svg { fill: #000; width: 18px; height: 18px; }

    .limit-info { font-size: 12px; opacity: 0.6; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="header"><div class="header-title">Gemini Premium AI</div></div>
  
  <div id="chat">
    <div class="bubble bot">
      Привет! Я готов к работе. О чем пообщаемся?<br><br>
      <div class="limit-info">
        ⚠️ История очистится при выходе.<br>
        ⏳ При лимитах чат заблокируется на короткую паузу.
      </div>
    </div>
  </div>

  <div class="input-box">
    <div class="input-wrap">
      <input id="input" type="text" placeholder="Спроси меня о чем угодно..." autocomplete="off">
      <button id="send-btn" onclick="send()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  tg.headerColor = "#161618";

  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const btn = document.getElementById('send-btn');

  function addMessage(text, role) {
    const div = document.createElement('div');
    div.className = `bubble ${role}`;
    if (role === 'bot') {
      div.innerHTML = marked.parse(text);
      const cp = document.createElement('div');
      cp.className = 'copy-btn'; cp.innerText = 'Копировать';
      cp.onclick = () => {
        navigator.clipboard.writeText(text); cp.innerText = 'Готово!';
        setTimeout(() => cp.innerText = 'Копировать', 2000);
        tg.HapticFeedback.notificationOccurred('success');
      };
      div.appendChild(cp);
    } else { div.textContent = text; }
    chat.appendChild(div);
    chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
    return div;
  }

  async function send() {
    const text = input.value.trim();
    if (!text || btn.disabled) return;
    
    input.value = '';
    tg.HapticFeedback.impactOccurred('light');
    addMessage(text, 'user');
    const load = addMessage('Генерирую ответ...', 'bot');

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      load.remove();
      addMessage(data.answer, 'bot');

      if (data.is_limit) startLockdown(25);
    } catch (e) {
      load.remove();
      addMessage('❌ Ошибка связи с сервером.', 'bot');
    }
  }

  function startLockdown(sec) {
    let left = sec;
    input.disabled = true; btn.disabled = true;
    const timer = setInterval(() => {
      input.placeholder = `Лимит! Пауза: ${left}с`;
      if (left-- <= 0) {
        clearInterval(timer); input.disabled = false; btn.disabled = false;
        input.placeholder = "Спроси меня о чем угодно...";
      }
    }, 1000);
  }

  input.addEventListener('keypress', (e) => { if(e.key==='Enter') send(); });
</script>
</body>
</html>
